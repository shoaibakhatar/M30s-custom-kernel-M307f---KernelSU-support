name: Build Exynos9610 M30s Kernel

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: "Defconfig name (in arch/arm64/configs/)"
        required: true
        default: "exynos9610-m30sdd_defconfig"
      with_kernelsu:
        description: "true = build with KernelSU (CONFIG_KSU=y). false = build without KernelSU (adds stub symbols so it links)"
        required: true
        default: "false"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison flex make git zip unzip xz-utils file rsync \
            libssl-dev libelf-dev dwarves \
            ccache \
            python3 \
            libncurses5 libtinfo5 || true

          # Fallback for newer runners where libtinfo.so.5 may not exist
          if ! ldconfig -p | grep -q "libtinfo.so.5"; then
            echo "libtinfo.so.5 not found, creating compatibility symlink (if possible)"
            sudo ln -sf /lib/x86_64-linux-gnu/libtinfo.so.6 /lib/x86_64-linux-gnu/libtinfo.so.5 || true
            sudo ln -sf /usr/lib/x86_64-linux-gnu/libtinfo.so.6 /usr/lib/x86_64-linux-gnu/libtinfo.so.5 || true
          fi

      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=${GITHUB_WORKSPACE}/.ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=3G" >> $GITHUB_ENV

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ runner.os }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ github.ref_name }}-
            ccache-${{ runner.os }}-

      - name: Toolchain env
        run: |
          # Adjust these if your repo uses different paths
          GCC_BIN="${GITHUB_WORKSPACE}/toolchains/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin"
          CLANG_BIN="${GITHUB_WORKSPACE}/toolchains/clang-4639204/bin"

          echo "GCC_BIN=$GCC_BIN" >> $GITHUB_ENV
          echo "CLANG_BIN=$CLANG_BIN" >> $GITHUB_ENV

          echo "$GCC_BIN" >> $GITHUB_PATH
          echo "$CLANG_BIN" >> $GITHUB_PATH

          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=11" >> $GITHUB_ENV
          echo "ANDROID_MAJOR_VERSION=r" >> $GITHUB_ENV

          echo "CROSS_COMPILE=${GCC_BIN}/aarch64-linux-android-" >> $GITHUB_ENV
          echo "CC=ccache ${CLANG_BIN}/clang" >> $GITHUB_ENV
          echo "CLANG_TRIPLE=${CLANG_BIN}/aarch64-linux-gnu-" >> $GITHUB_ENV

      - name: Add KernelSU stub symbols (ONLY when building without KernelSU)
        if: ${{ inputs.with_kernelsu != 'true' }}
        run: |
          # These stubs satisfy the linker if your tree has KernelSU hook calls
          # but you don't want CONFIG_KSU=y.
          cat > kernel/ksu_stub.c <<'EOF'
          // Auto-generated by CI to allow building without KernelSU
          #include <linux/types.h>
          #include <linux/cache.h>
          #include <linux/fs.h>
          #include <linux/cred.h>
          #include <linux/uaccess.h>

          // Match the hook variables used by KernelSU integration patches
          bool ksu_execveat_hook __read_mostly;
          bool ksu_vfs_read_hook __read_mostly;
          bool ksu_input_hook __read_mostly;

          // Match the handler prototypes shown in KernelSU non-GKI integration docs
          int ksu_handle_faccessat(int *dfd, const char __user **filename_user, int *mode, int *flags) { return 0; }
          int ksu_handle_stat(int *dfd, const char __user **filename_user, int *flags) { return 0; }

          int ksu_handle_vfs_read(struct file **file_ptr, char __user **buf_ptr,
                                  size_t *count_ptr, loff_t **pos) { return 0; }

          int ksu_handle_execveat(int *fd, struct filename **filename_ptr,
                                  void *argv, void *envp, int *flags) { return 0; }

          int ksu_handle_execveat_sucompat(int *fd, struct filename **filename_ptr,
                                           void *argv, void *envp, int *flags) { return 0; }

          int ksu_handle_input_handle_event(unsigned int *type, unsigned int *code, int *value) { return 0; }

          // Optional extra hook used by some KernelSU patchsets
          int ksu_handle_devpts(struct inode *inode) { return 0; }
          EOF

          # Build stub only when CONFIG_KSU is not set
          if ! grep -q "ksu_stub.o" kernel/Makefile; then
            cat >> kernel/Makefile <<'EOF'

          # Added by CI: link stubs when KernelSU is NOT enabled
          ifeq ($(CONFIG_KSU),)
          obj-y += ksu_stub.o
          endif
          EOF
          fi

      - name: Configure
        run: |
          mkdir -p out
          make O=out ARCH=${ARCH} ${{ inputs.defconfig }}

          # KernelPatch/APatch needs kallsyms (CONFIG_KALLSYMS=y). :contentReference[oaicite:5]{index=5}
          ./scripts/config --file out/.config -e KALLSYMS -e KALLSYMS_ALL || true
          make O=out ARCH=${ARCH} olddefconfig

          # If user chose KernelSU build, force it on (only if your tree supports it)
          if [ "${{ inputs.with_kernelsu }}" = "true" ]; then
            ./scripts/config --file out/.config -e KSU || true
            make O=out ARCH=${ARCH} olddefconfig
          fi

      - name: Build
        run: |
          make -j"$(nproc)" O=out ARCH=${ARCH} \
            CROSS_COMPILE="${CROSS_COMPILE}" \
            CC="${CC}" \
            CLANG_TRIPLE="${CLANG_TRIPLE}"

      - name: Collect artifacts
        run: |
          mkdir -p artifacts

          cp -v out/arch/arm64/boot/Image artifacts/ || true
          cp -v out/.config artifacts/config || true

          # Modules (optional)
          find out -name "*.ko" -type f -print0 | xargs -0 -I{} cp -v {} artifacts/ || true

          (cd artifacts && zip -r "../kernel-${{ inputs.defconfig }}.zip" .)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ inputs.defconfig }}-${{ inputs.with_kernelsu }}
          path: kernel-${{ inputs.defconfig }}.zip
